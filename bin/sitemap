#!/bin/zsh -e

mydir=${0:a:h}
cd $mydir/..

NAME=$(git config remote.origin.url |cut -f2 -d: |cut -d/ -f1)
REPO=$(git config remote.origin.url |cut -f2 -d: |cut -d/ -f2)
OUTFILE=_site/sitemap.xml

PREFIX=https://$NAME.github.io/$REPO
[ -e CNAME ]  &&  PREFIX=https://$(cat CNAME)

function sitemap() {
  echo '
  <urlset xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
  ' >| $OUTFILE

  for htm in $(cd _site && find . -mindepth 2 -name index.html | cut -f2- -d/ |sort -r); do
      echo -n .
      dir=$(dirname -- "$htm")
      echo "
  <url>
    <loc>$PREFIX/$dir/</loc>
  </url>" >> $OUTFILE
  done

  echo '</urlset>' >> $OUTFILE


  echo "Sitemap: $PREFIX/sitemap.xml" >| _site/robots.txt
  echo
}

function keeps() { # xxx only modify keep_files
  (
    echo '
exclude:
  - bin
  - README.md
keep_files:'
    for i in $(/bin/ls _site); do
      echo "  - '$i'"
    done
  ) >| _config.yml
}


sitemap
keeps
